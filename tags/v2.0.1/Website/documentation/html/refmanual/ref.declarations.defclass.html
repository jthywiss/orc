<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1"><title>4.3.&nbsp;def class: Define Site in Orc</title><meta content="DocBook XSL-NS Stylesheets V1.76.1" name="generator"><link rel="home" href="index.html" title="Orc Reference Manual v2.0.1"><link rel="up" href="ref.declarations.html" title="Chapter&nbsp;4.&nbsp;Declarations"><link rel="prev" href="ref.declarations.def.html" title="4.2.&nbsp;def: Define Function"><link rel="next" href="ref.declarations.site.html" title="4.4.&nbsp;import site: Import Site"><link rel="copyright" href="legalnotice.html" title="License and Grant Information"><link xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/css" rel="stylesheet" href="/orchard/orc.css"><link xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" href="style.css" type="text/css" rel="stylesheet"><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript">
// Expandable content script from flooble.com.
// For more information please visit:
// http://www.flooble.com/scripts/expand.php
// Copyright 2002 Animus Pactum Consulting Inc.
//----------------------------------------------
function toggle(link, divId) {
	var lText = link.innerHTML;
	var d = document.getElementById(divId);
	if (lText == '+') {
		link.innerHTML = '&#8722;';
		d.style.display = 'block';
	} else {
		link.innerHTML = '+';
		d.style.display = 'none';
	}
}
</script></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="navheader"><table summary="Navigation header" width="100%"><tr><th align="center" colspan="3"><a accesskey="h" href="index.html"><img src="images/home.gif" alt="Table of Contents"></a></th></tr><tr><td align="left" width="20%"><a accesskey="p" href="ref.declarations.def.html"><img src="images/prev.gif" alt="Prev"></a>&nbsp;</td><th align="center" width="60%"><a accesskey="u" href="ref.declarations.html">Chapter&nbsp;4.&nbsp;Declarations</a></th><td align="right" width="20%">&nbsp;<a accesskey="n" href="ref.declarations.site.html"><img src="images/next.gif" alt="Next"></a></td></tr><tr><td align="left" width="20%"><a href="ref.declarations.def.html">4.2.&nbsp;<code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code>:  Define Function</a>&nbsp;</td><th align="center" width="60%">4.3.&nbsp;<code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code>: Define Site in Orc</th><td align="right" width="20%"><a href="ref.declarations.site.html">4.4.&nbsp;<code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">import</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">site</span></code>: Import Site</a>&nbsp;</td></tr></table></div><div class="section" title="4.3.&nbsp;def class: Define Site in Orc"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ref.declarations.defclass"></a>4.3.&nbsp;<code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code>: Define Site in Orc</h2></div></div></div><p>
      The <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code> declaration provides the capability to implement 
      <a class="link" href="ref.sites.html" title="Chapter&nbsp;6.&nbsp;Sites and Services">sites</a> within Orc itself.
      It is syntactically similar to the <a class="link" href="ref.declarations.def.html" title="4.2.&nbsp;def: Define Function"><code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code> declaration</a>, but serves a different purpose. 
      </p><p>
      The body of a <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code> consists of a sequence of declarations followed by a 
      <a name="N41D05" class="indexterm"></a><em class="firstterm">goal</em> expression. Each <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code> or
			<code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code> declaration in this sequence is called a <a name="N41D13" class="indexterm"></a><em class="firstterm">method</em>; 
			a class must have at least one method.       
      </p><p>
      </p><p>
      Orc's <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code> provides encapsulation in a manner similar to classes in object-oriented
      languages. In addition to colocating methods and the shared resources on which they operate,
      an Orc class may also encapsulate some computation via the goal expression, colocating methods 
      and resources with some orchestration which manages or monitors those resources.  
      </p><div class="section" title="4.3.1.&nbsp;Syntax"><div class="titlepage"><div><div><h3 class="title"><a name="ref.declarations.defclass.syntax"></a>4.3.1.&nbsp;Syntax</h3></div></div></div><p>
	    </p><table cellpadding="5" width="100%" class="productionset" summary="EBNF"><tr><td><table cellpadding="0" width="99%" border="0" class="productionset" summary="EBNF productions"><tr><td width="3%" valign="top" align="left">[23]</td><td width="10%" valign="top" align="right"><a href="ref.syntax.EBNF.html#ebnf.declaration.defclass"><a class="link" href="ref.declarations.defclass.html" title="4.3.&nbsp;def class: Define Site in Orc">DeclareDefclass</a></a></td><td align="center" width="5%" valign="top"><code>::=</code></td><td width="52%" valign="top">
		    <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code> <a href="ref.syntax.EBNF.html#ebnf.variable">Variable</a> <a href="ref.syntax.EBNF.html#ebnf.typeparameters">TypeParameters</a><span class="bold"><strong>?</strong></span> <a href="ref.syntax.EBNF.html#ebnf.parameters">Parameters</a> <a href="ref.syntax.EBNF.html#ebnf.returntype">ReturnType</a><span class="bold"><strong>?</strong></span> <a href="ref.syntax.EBNF.html#ebnf.guard">Guard</a><span class="bold"><strong>?</strong></span> <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-operator">=</span></code> <a href="ref.syntax.EBNF.html#ebnf.declaration">Declaration</a><span class="bold"><strong>+</strong></span> <a href="ref.syntax.EBNF.html#ebnf.expression">Expression</a> 
		  </td><td width="30%" valign="top" align="left">&nbsp;</td></tr></table></td></tr></table><p>
	  </p></div><div class="section" title="4.3.2.&nbsp;Creating Instances"><div class="titlepage"><div><div><h3 class="title"><a name="ref.declarations.defclass.instances"></a>4.3.2.&nbsp;Creating Instances</h3></div></div></div><p>
	  A <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code> declaration binds its identifier to a new site, which we call an Orc class. 
	  When this site is called, it creates and <a class="link" href="ref.concepts.publish.html" title="8.1.&nbsp;Publication">publishes</a> an <a name="N41D3A" class="indexterm"></a><em class="firstterm">instance</em>, 
	  a site which has all of the methods defined in the class.
	  </p><p>
	  In parallel, execution of the goal expression begins. 
	  Any value published by the goal expression is discarded. 
	  The class is a site, meaning that the execution of the goal expression cannot be <a class="link" href="ref.concepts.states.html#ref.concepts.states.kill" title="8.3.4.&nbsp;Killed">killed</a> by Orc; 
	  it continues independently of the rest of the program.
	  </p><p>
	  When an instance is created, each <a class="link" href="ref.declarations.val.html" title="4.1.&nbsp;val: Bind Value"><code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">val</span></code> declaration</a> begins to execute, 
	  and each method is captured as a <a class="link" href="ref.data.closure.html" title="1.9.&nbsp;Closures">closure</a>.
	  This has two important implications:
	  
	  </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
        Different instances will have different values for each <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">val</span></code> declaration,
        created by separate computations, and these bindings are captured by the method closures.
        In particular, this means that an instance could create some <a class="link" href="ref.data.mutable.html" title="1.10.&nbsp;Mutable State">mutable resource</a>, such as
        a mutable cell or a semaphore, which is then manipulated by the methods; different
        instances will have different underlying mutable resources. Instances are thus very similar 
        to objects in object-oriented languages, and <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">val</span></code> declarations are analogous to
        private fields.
      </p></li><li class="listitem"><p>
        Recall that creation of a closure is strict in the closure's free variables. Thus,
        the creation of the instance may block on some free variable within the class (i.e.
        a variable bound by <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">val</span></code>), or a free variable in the scope of the class.
        In practice, this means that instance creation will block on every <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">val</span></code>
        declaration whose name is mentioned in any method. Furthermore, the goal expression
        might begin executing even before the instance is published.
      </p></li></ul></div><p>
	  
	  </p></div><div class="section" title="4.3.3.&nbsp;Calling Methods"><div class="titlepage"><div><div><h3 class="title"><a name="ref.declarations.defclass.methods"></a>4.3.3.&nbsp;Calling Methods</h3></div></div></div><p>
	  Each instance returned by a call to the class has a method for each <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code> or <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code>
	  declaration in the class body. A method is accessed using a <a class="link" href="ref.expressions.dot.html" title="2.5.&nbsp;Dot Access">dot access</a>;
	  the identifier name of the declaration is used as the key. When a method is called, the corresponding definition
	  executes.
	  </p><p>
	  Each method behaves as a site, in particular a <a class="link" href="ref.concepts.helpful.html" title="8.5.&nbsp;Helpful Sites">helpful</a> site. Therefore,
	  
	  </p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p>
	      A method call, unlike a <a class="link" href="ref.expressions.call.html#ref.expressions.call.function" title="2.4.3.&nbsp;Function Calls">function call</a>, is strict in all of its arguments.
	    </p></li><li class="listitem"><p>
        A method call publishes at most one value. If the method is a <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code>, its first publication
        is used, and execution of the body continues, but subsequent publications are ignored.   
      </p></li><li class="listitem"><p>
        If the method is a <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code>, and execution of its body expression <a class="link" href="ref.concepts.states.html#ref.concepts.states.halt" title="8.3.3.&nbsp;Halted">halts</a> <a class="link" href="ref.concepts.silent.html" title="8.2.&nbsp;Silence">silently</a>,
        then the method call also halts silently, exactly like a helpful site.   
      </p></li><li class="listitem"><p>
        A method call cannot be <a name="N41DA0" class="indexterm"></a><a class="link" href="ref.concepts.states.html#ref.concepts.states.kill" title="8.3.4.&nbsp;Killed">killed</a> by the pruning combinator.
        Once the method has been called, its execution continues independently of the rest of the Orc program. 
      </p></li></ul></div><p>
	  
	  </p><p>
	    The <a name="N41DAA" class="indexterm"></a>methods of an instance may be executed concurrently through concurrent invocations;
	    there is no synchronization or serialization mechanism to prevent this. Different calls to the same
	    method may even execute concurrently with each other.
	    If any method uses a shared resource, care must be taken to ensure that different method invocations
	    do not interfere with each other in unexpected ways.
    </p></div><div class="section" title="4.3.4.&nbsp;Type"><div class="titlepage"><div><div><h3 class="title"><a name="ref.declarations.defclass.type"></a>4.3.4.&nbsp;Type</h3></div></div></div><p>
	      A <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code> declaration is typechecked in the same way as a <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code> declaration, with one exception.
	      The return type of a <a name="N41DBA" class="indexterm"></a>closure created by <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span> <span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-variable">class</span></code>, rather than being the type of the body expression, is instead a <a class="link" href="ref.data.record.html#ref.data.record.type" title="1.7.5.&nbsp;Type">record type</a>
	      <code class="code">{.</code> <em class="replaceable"><code>m<sub>0</sub></code></em> <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-operator">:</span><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-operator">:</span></code> <em class="replaceable"><code>T<sub>0</sub></code></em> <code class="code">,</code> &hellip; <code class="code">,</code> <em class="replaceable"><code>m<sub>n</sub></code></em> <code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-operator">:</span><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-operator">:</span></code> <em class="replaceable"><code>T<sub>n</sub></code></em> <code class="code">.}</code>,
	      where each <em class="replaceable"><code>m<sub>i</sub></code></em> is the name of a method,
	      and <em class="replaceable"><code>T<sub>i</sub></code></em> is its type.
	    </p></div><div class="section" title="4.3.5.&nbsp;Examples"><div class="titlepage"><div><div><h3 class="title"><a name="ref.declarations.defclass.examples"></a>4.3.5.&nbsp;Examples</h3></div></div></div><div xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="example"><div class="exampleHeading"><a class="showHideToggle" href="javascript: void(0);" title="show/hide" id="ref.declarations.defclass.semantics.examples.matrix_link" onclick="toggle(this, 'ref.declarations.defclass.semantics.examples.matrix_content')">
					&minus;
				</a><span class="exampleCaption">Matrix Definition</span></div><div class="exampleBody" id="ref.declarations.defclass.semantics.examples.matrix_content"><p>
	  		Orc's standard library supports only one dimensional arrays, and array
			indices always start at 0. We define a template for a 2-dimensional matrix whose
			row and column indices range over arbitrary intervals.
	  	</p><pre class="orc">
<span class="hl-comment">{- Create a matrix whose indices range from 
   (rowlo, collo) to (rowhi, colhi) inclusive,
   with a method to access its elements.
-}</span>

<span class="hl-keyword">def</span> <span class="hl-variable">class</span> <span class="hl-site">Matrix</span>((<span class="hl-variable">rowlo</span>, <span class="hl-variable">rowhi</span>), (<span class="hl-variable">collo</span>, <span class="hl-variable">colhi</span>)) <span class="hl-operator">=</span>
 <span class="hl-keyword">val</span> <span class="hl-variable">mat</span> <span class="hl-operator">=</span> <span class="hl-site">Array</span>((<span class="hl-variable">rowhi</span> <span class="hl-operator">-</span> <span class="hl-variable">rowlo</span> <span class="hl-operator">+</span> <span class="hl-literal">1</span>) <span class="hl-operator">*</span> (<span class="hl-variable">colhi</span> <span class="hl-operator">-</span> <span class="hl-variable">collo</span> <span class="hl-operator">+</span> <span class="hl-literal">1</span>))

 <span class="hl-keyword">def</span> <span class="hl-site">access</span>(<span class="hl-variable">i</span>, <span class="hl-variable">j</span>) <span class="hl-operator">=</span> <span class="hl-site">mat</span>((<span class="hl-variable">i</span> <span class="hl-operator">-</span> <span class="hl-variable">rowlo</span>) <span class="hl-operator">*</span> (<span class="hl-variable">colhi</span> <span class="hl-operator">-</span> <span class="hl-variable">collo</span> <span class="hl-operator">+</span> <span class="hl-literal">1</span>) <span class="hl-operator">+</span> <span class="hl-variable">j</span>)

<span class="hl-keyword">stop</span>

<span class="hl-comment">{- Usage -}</span>
<span class="hl-keyword">val</span> <span class="hl-variable">A</span> <span class="hl-operator">=</span> <span class="hl-site">Matrix</span>((<span class="hl-operator">-</span><span class="hl-literal">2</span>, <span class="hl-literal">0</span>), (<span class="hl-operator">-</span><span class="hl-literal">1</span>, <span class="hl-literal">3</span>)).<span class="hl-variable">access</span>
<span class="hl-site">A</span>(<span class="hl-operator">-</span><span class="hl-literal">1</span>, <span class="hl-literal">2</span>) <span class="hl-operator">:=</span> <span class="hl-literal">5</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">A</span>(<span class="hl-operator">-</span><span class="hl-literal">1</span>, <span class="hl-literal">2</span>) <span class="hl-operator">:=</span> <span class="hl-literal">3</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">A</span>(<span class="hl-operator">-</span><span class="hl-literal">1</span>, <span class="hl-literal">2</span>)<span class="hl-operator">?</span>

<span class="hl-comment">{-
OUTPUT:
3
-}</span>
</pre><p>
		  	Note: We have defined <code class="code"><span class="hl-variable">A</span></code> as the "access" method of the defined
			matrix. This allows us to retrieve and update the matrix elements using
			traditional notation.
		  </p></div></div><noscript xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook"><p>"WARNING: This example requires Javascript to be rendered correctly. Please enable it in your browser."</p></noscript><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript">
toggle(document.getElementById('ref.declarations.defclass.semantics.examples.matrix_link'), 'ref.declarations.defclass.semantics.examples.matrix_content');
</script><div xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="example"><div class="exampleHeading"><a class="showHideToggle" href="javascript: void(0);" title="show/hide" id="ref.declarations.defclass.semantics.examples.createsite_link" onclick="toggle(this, 'ref.declarations.defclass.semantics.examples.createsite_content')">
					&minus;
				</a><span class="exampleCaption">Create a Write-Once Site</span></div><div class="exampleBody" id="ref.declarations.defclass.semantics.examples.createsite_content"><p>
		  	We create a site, <code class="code"><a name="N41E0E" class="indexterm"></a><span class="hl-variable">Cell</span></code>, that defines a write-once variable. It
			supports two methods: <code class="code"><span class="hl-variable">read</span></code> <a class="link" href="ref.concepts.states.html#ref.concepts.states.block" title="8.3.2.&nbsp;Blocked">blocks</a> until the variable has been
			written, and then it publishes its value; <code class="code"><span class="hl-site">write</span>(<span class="hl-variable">v</span>)</code> <a class="link" href="ref.concepts.states.html#ref.concepts.states.block" title="8.3.2.&nbsp;Blocked">blocks</a> forever if a value has
			already been written, otherwise it writes <code class="code"><span class="hl-variable">v</span></code> as the value and
			publishes a <code class="code"><span class="hl-keyword">signal</span></code>.
		  </p><p>
		  	We use two library sites, <code class="code"><a name="N41E2A" class="indexterm"></a><span class="hl-variable">Semaphore</span></code> (to ensure <a class="link" href="ref.concepts.states.html#ref.concepts.states.block" title="8.3.2.&nbsp;Blocked">blocking</a> of write if a
			value has been written) and <code class="code"><a name="N41E34" class="indexterm"></a><span class="hl-variable">Ref</span></code> to store the value.
		  </p><pre class="orc">
<span class="hl-comment">{- Create a mutable cell site -}</span>

<span class="hl-keyword">def</span> <span class="hl-variable">class</span> <span class="hl-site">Cell</span>() <span class="hl-operator">=</span>
  <span class="hl-keyword">val</span> <span class="hl-variable">s</span> <span class="hl-operator">=</span> <span class="hl-site">Semaphore</span>(<span class="hl-literal">1</span>)
  <span class="hl-keyword">val</span> <span class="hl-variable">r</span> <span class="hl-operator">=</span> <span class="hl-site">Ref</span>()

  <span class="hl-keyword">def</span> <span class="hl-site">write</span>(<span class="hl-variable">v</span>) <span class="hl-operator">=</span> <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">r</span> <span class="hl-operator">:=</span> <span class="hl-variable">v</span>
  <span class="hl-keyword">def</span> <span class="hl-site">read</span>() <span class="hl-operator">=</span> <span class="hl-variable">r</span><span class="hl-operator">?</span>

  <span class="hl-keyword">stop</span>

<span class="hl-keyword">val</span> <span class="hl-variable">c</span> <span class="hl-operator">=</span> <span class="hl-site">Cell</span>()

<span class="hl-variable">c</span> <span class="hl-operator">:=</span> <span class="hl-literal">42</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">c</span><span class="hl-operator">?</span>

<span class="hl-comment">{-
OUTPUT:
42
-}</span>
</pre></div></div><noscript xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook"><p>"WARNING: This example requires Javascript to be rendered correctly. Please enable it in your browser."</p></noscript><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript">
toggle(document.getElementById('ref.declarations.defclass.semantics.examples.createsite_link'), 'ref.declarations.defclass.semantics.examples.createsite_content');
</script><div xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="example"><div class="exampleHeading"><a class="showHideToggle" href="javascript: void(0);" title="show/hide" id="ref.declarations.defclass.semantics.examples.extendsite_link" onclick="toggle(this, 'ref.declarations.defclass.semantics.examples.extendsite_content')">
					&minus;
				</a><span class="exampleCaption">Extend Functionality of an Existing Site</span></div><div class="exampleBody" id="ref.declarations.defclass.semantics.examples.extendsite_content"><p>
		  	The <code class="code"><a name="N41E43" class="indexterm"></a><span class="hl-variable">Channel</span></code> site 
		  	implements an unbounded channel. We add a new method,
			<code class="code"><span class="hl-variable">length</span></code>, that returns the number of items in the channel. 
		  </p><pre class="orc">
<span class="hl-comment">{- Extend the pre existing channel site with a length field -}</span>

<span class="hl-keyword">def</span> <span class="hl-variable">class</span> <span class="hl-site">CustomChannel</span>() <span class="hl-operator">=</span>
  <span class="hl-keyword">val</span> <span class="hl-variable">ch</span> <span class="hl-operator">=</span> <span class="hl-site">Channel</span>()
  <span class="hl-keyword">val</span> <span class="hl-variable">chlen</span> <span class="hl-operator">=</span> <span class="hl-site">Counter</span>(<span class="hl-literal">0</span>)

  <span class="hl-keyword">def</span> <span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-operator">=</span> <span class="hl-variable">ch</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">chlen</span>.<span class="hl-site">inc</span>()
  <span class="hl-keyword">def</span> <span class="hl-site">get</span>() <span class="hl-operator">=</span> <span class="hl-variable">ch</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">chlen</span>.<span class="hl-site">dec</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>
  <span class="hl-keyword">def</span> <span class="hl-site">length</span>() <span class="hl-operator">=</span> <span class="hl-variable">chlen</span>.<span class="hl-site">value</span>()

  <span class="hl-keyword">stop</span>

<span class="hl-keyword">val</span> <span class="hl-variable">cc</span> <span class="hl-operator">=</span> <span class="hl-site">CustomChannel</span>()

  <span class="hl-site">signals</span>(<span class="hl-literal">10</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">cc</span>.<span class="hl-site">put</span>(<span class="hl-literal">"item"</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">|</span> <span class="hl-site">signals</span>(<span class="hl-literal">5</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">cc</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-keyword">stop</span>
<span class="hl-combinator">;</span> <span class="hl-variable">cc</span>.<span class="hl-site">length</span>()

<span class="hl-comment">{-
OUTPUT:
5
-}</span>
</pre></div></div><noscript xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook"><p>"WARNING: This example requires Javascript to be rendered correctly. Please enable it in your browser."</p></noscript><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript">
toggle(document.getElementById('ref.declarations.defclass.semantics.examples.extendsite_link'), 'ref.declarations.defclass.semantics.examples.extendsite_content');
</script><div xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="example"><div class="exampleHeading"><a class="showHideToggle" href="javascript: void(0);" title="show/hide" id="ref.declarations.defclass.semantics.examples.concaccess_link" onclick="toggle(this, 'ref.declarations.defclass.semantics.examples.concaccess_content')">
					&minus;
				</a><span class="exampleCaption">Managing Concurrent Access</span></div><div class="exampleBody" id="ref.declarations.defclass.semantics.examples.concaccess_content"><p>
		  	The methods of a class instance may be executed concurrently through
			concurrent invocations. Concurrent execution may cause interference,
			as in the example of the <code class="code"><span class="hl-variable">Newset</span></code> example. Typically, <a name="N41E57" class="indexterm"></a>semaphores are used to
			restrict access to methods and/or data. We rewrite <code class="code"><span class="hl-variable">Newset</span></code> in which all
			accesses to shared data <code class="code"><span class="hl-variable">ne</span></code> are protected using a semaphore.
		  </p><pre class="orc">
<span class="hl-comment">{- Manage access to a set via a site -}</span>

<span class="hl-keyword">def</span> <span class="hl-variable">class</span> <span class="hl-site">Newset</span>(<span class="hl-variable">n</span>) <span class="hl-operator">=</span>
 <span class="hl-keyword">val</span> <span class="hl-variable">b</span> <span class="hl-operator">=</span> <span class="hl-site">BoundedChannel</span>(<span class="hl-variable">n</span>)
 <span class="hl-keyword">val</span> (<span class="hl-variable">s</span> , <span class="hl-variable">ne</span>) <span class="hl-operator">=</span> (<span class="hl-site">Semaphore</span>(<span class="hl-literal">1</span>) , <span class="hl-site">Ref</span>(<span class="hl-literal">0</span>))

 <span class="hl-comment">{- Add an element to the set if it is non-full.
   If the set is full, wait until the set becomes non-full.
   Return a signal on completion.
 -}</span>
 <span class="hl-keyword">def</span> <span class="hl-site">add</span>(<span class="hl-variable">x</span>) <span class="hl-operator">=</span> <span class="hl-variable">b</span>.<span class="hl-site">put</span>(<span class="hl-variable">x</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">ne</span> <span class="hl-operator">:=</span> <span class="hl-variable">ne</span><span class="hl-operator">?</span> <span class="hl-operator">+</span> <span class="hl-literal">1</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">release</span>()

 <span class="hl-comment">{- Remove some element from the set if it is non-empty.
   If the set is empty, wait until the set becomes non-empty.
   Return the removed value.
 -}</span>
 <span class="hl-keyword">def</span> <span class="hl-site">remove</span>() <span class="hl-operator">=</span> <span class="hl-variable">b</span>.<span class="hl-site">get</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">ne</span> <span class="hl-operator">:=</span> <span class="hl-variable">ne</span><span class="hl-operator">?</span> <span class="hl-operator">-</span> <span class="hl-literal">1</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
   <span class="hl-variable">s</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>

 <span class="hl-comment">{- Return the size, i.e., the number of elements currently in the set
 -}</span>
 <span class="hl-keyword">def</span> <span class="hl-site">size</span>() <span class="hl-operator">=</span> <span class="hl-variable">s</span>.<span class="hl-site">acquire</span>() <span class="hl-variable">ne</span><span class="hl-operator">?</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">x</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">s</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">x</span>

<span class="hl-keyword">stop</span>

<span class="hl-comment">{-
OUTPUT:
-}</span>
</pre></div></div><noscript xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook"><p>"WARNING: This example requires Javascript to be rendered correctly. Please enable it in your browser."</p></noscript><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript">
toggle(document.getElementById('ref.declarations.defclass.semantics.examples.concaccess_link'), 'ref.declarations.defclass.semantics.examples.concaccess_content');
</script><div xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="example"><div class="exampleHeading"><a class="showHideToggle" href="javascript: void(0);" title="show/hide" id="ref.declarations.defclass.semantics.examples.goal_link" onclick="toggle(this, 'ref.declarations.defclass.semantics.examples.goal_content')">
					&minus;
				</a><span class="exampleCaption">Computing with the Goal Expression</span></div><div class="exampleBody" id="ref.declarations.defclass.semantics.examples.goal_content"><p>
		  	All the goal expressions shown so far have been merely <code class="code"><span class="hl-keyword">stop</span></code>. In the
			following example, the goal expression of the class initiates an
			computation in which a number is printed every second; all the
			publications of the goal expression are ignored.
		  </p><pre class="orc">
<span class="hl-comment">{- Perform a print action with the goal expression 
   of a class: counting down from n to 0.
-}</span>

<span class="hl-keyword">def</span> <span class="hl-variable">class</span> <span class="hl-site">countdown</span>(<span class="hl-variable">n</span>) <span class="hl-operator">=</span>

 <span class="hl-keyword">def</span> <span class="hl-site">downfrom</span>(<span class="hl-variable">i</span>) <span class="hl-keyword">if</span> (<span class="hl-variable">i</span> <span class="hl-operator">&gt;=</span> <span class="hl-literal">0</span>) <span class="hl-operator">=</span> <span class="hl-variable">i</span> <span class="hl-combinator">|</span> <span class="hl-site">Rwait</span>(<span class="hl-literal">1000</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">downfrom</span>(<span class="hl-variable">i</span><span class="hl-operator">-</span><span class="hl-literal">1</span>)

 <span class="hl-comment">{- Goal -}</span> <span class="hl-site">downfrom</span>(<span class="hl-variable">n</span>) <span class="hl-combinator">&gt;</span><span class="hl-variable">i</span><span class="hl-combinator">&gt;</span> <span class="hl-site">Println</span>(<span class="hl-variable">i</span>)

<span class="hl-keyword">val</span> <span class="hl-variable">_</span> <span class="hl-operator">=</span> <span class="hl-site">countdown</span>(<span class="hl-literal">5</span>)
<span class="hl-comment">{- Goal of the whole program -}</span>  <span class="hl-keyword">stop</span>

<span class="hl-comment">{-
OUTPUT:
5
4
3
2
1
0
-}</span>
</pre></div></div><noscript xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook"><p>"WARNING: This example requires Javascript to be rendered correctly. Please enable it in your browser."</p></noscript><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript">
toggle(document.getElementById('ref.declarations.defclass.semantics.examples.goal_link'), 'ref.declarations.defclass.semantics.examples.goal_content');
</script><div xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="example"><div class="exampleHeading"><a class="showHideToggle" href="javascript: void(0);" title="show/hide" id="ref.declarations.defclass.semantics.examples.stopwatch_link" onclick="toggle(this, 'ref.declarations.defclass.semantics.examples.stopwatch_content')">
					&minus;
				</a><span class="exampleCaption">Stopwatch</span></div><div class="exampleBody" id="ref.declarations.defclass.semantics.examples.stopwatch_content"><pre class="orc">
<span class="hl-comment">{- 
  An instance of Stopwatch has the following operations:
     
    start():  
      Start a paused stopwatch and publish a signal.
      If the stopwatch is already running, halt instead.
    finish(): 
      Pause a running stopwatch and publish the time
      that has passed since it was last started.
      If the stopwatch is already paused, halt instead.
-}</span> 

<span class="hl-keyword">def</span> <span class="hl-variable">class</span> <span class="hl-site">Stopwatch</span>() <span class="hl-operator">=</span>
  <span class="hl-keyword">val</span> <span class="hl-variable">now</span> <span class="hl-operator">=</span> <span class="hl-site">Rclock</span>().<span class="hl-variable">time</span> 
  <span class="hl-keyword">val</span> <span class="hl-variable">checkpoint</span> <span class="hl-operator">=</span> <span class="hl-site">Ref</span>(<span class="hl-site">now</span>())
  <span class="hl-keyword">val</span> (<span class="hl-variable">startlock</span>, <span class="hl-variable">finishlock</span>) <span class="hl-operator">=</span> (<span class="hl-site">Semaphore</span>(<span class="hl-literal">0</span>), <span class="hl-site">Semaphore</span>(<span class="hl-literal">0</span>))
  <span class="hl-keyword">def</span> <span class="hl-site">start</span>() <span class="hl-operator">=</span> 
    <span class="hl-variable">startlock</span>.<span class="hl-site">acquireD</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-site">now</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">starttime</span><span class="hl-combinator">&gt;</span> 
      <span class="hl-variable">checkpoint</span> <span class="hl-operator">:=</span> <span class="hl-variable">starttime</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-variable">finishlock</span>.<span class="hl-site">release</span>()
  <span class="hl-keyword">def</span> <span class="hl-site">finish</span>() <span class="hl-operator">=</span>
    <span class="hl-variable">finishlock</span>.<span class="hl-site">acquireD</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
      <span class="hl-variable">checkpoint</span><span class="hl-operator">?</span> <span class="hl-combinator">&gt;</span><span class="hl-variable">starttime</span><span class="hl-combinator">&gt;</span>
      <span class="hl-site">now</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">endtime</span><span class="hl-combinator">&gt;</span>
      <span class="hl-variable">checkpoint</span> <span class="hl-operator">:=</span> <span class="hl-variable">endtime</span> <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-variable">startlock</span>.<span class="hl-site">release</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
    <span class="hl-variable">endtime</span> <span class="hl-operator">-</span> <span class="hl-variable">starttime</span>
  
  <span class="hl-variable">startlock</span>.<span class="hl-site">release</span>()    
  
  
<span class="hl-keyword">val</span> <span class="hl-variable">watch</span> <span class="hl-operator">=</span> <span class="hl-site">Stopwatch</span>()

<span class="hl-variable">watch</span>.<span class="hl-site">start</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">Rwait</span>(<span class="hl-literal">400</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">watch</span>.<span class="hl-site">finish</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">i</span><span class="hl-combinator">&gt;</span>
<span class="hl-site">Rwait</span>(<span class="hl-literal">200</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span>
<span class="hl-variable">watch</span>.<span class="hl-site">start</span>() <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-site">Rwait</span>(<span class="hl-literal">100</span>) <span class="hl-combinator">&gt;</span><span class="hl-combinator">&gt;</span> <span class="hl-variable">watch</span>.<span class="hl-site">finish</span>() <span class="hl-combinator">&gt;</span><span class="hl-variable">j</span><span class="hl-combinator">&gt;</span>
(<span class="hl-variable">i</span><span class="hl-operator">+</span><span class="hl-variable">j</span> <span class="hl-operator">&gt;=</span> <span class="hl-literal">500</span>) <span class="hl-operator">&amp;&amp;</span> (<span class="hl-variable">i</span><span class="hl-operator">+</span><span class="hl-variable">j</span> <span class="hl-operator">&lt;=</span> <span class="hl-literal">525</span>)

<span class="hl-comment">{-
OUTPUT:
true
-}</span>
</pre></div></div><noscript xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook"><p>"WARNING: This example requires Javascript to be rendered correctly. Please enable it in your browser."</p></noscript><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript">
toggle(document.getElementById('ref.declarations.defclass.semantics.examples.stopwatch_link'), 'ref.declarations.defclass.semantics.examples.stopwatch_content');
</script></div><div class="section" title="4.3.6.&nbsp;Related Links"><div class="titlepage"><div><div><h3 class="title"><a name="ref.declarations.defclass.links"></a>4.3.6.&nbsp;Related Links</h3></div></div></div><div class="itemizedlist" title="Related Reference Topics"><p class="title"><b>Related Reference Topics</b></p><ul class="itemizedlist" type="disc"><li class="listitem"><p><a class="link" href="ref.expressions.call.html#ref.expressions.call.site" title="2.4.2.&nbsp;Site Calls">Site Calls</a></p></li><li class="listitem"><p><a class="link" href="ref.expressions.dot.html" title="2.5.&nbsp;Dot Access">Dot Access</a></p></li><li class="listitem"><p><a class="link" href="ref.concepts.publish.html" title="8.1.&nbsp;Publication">Publication</a></p></li><li class="listitem"><p><a class="link" href="ref.data.record.html#ref.data.record.type" title="1.7.5.&nbsp;Type">Record Types</a></p></li><li class="listitem"><p><a class="link" href="ref.concepts.helpful.html" title="8.5.&nbsp;Helpful Sites">Helpful Sites</a></p></li><li class="listitem"><p><a class="link" href="ref.declarations.def.html" title="4.2.&nbsp;def: Define Function"><code class="code"><span xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" class="hl-keyword">def</span></code>:  Define Function</a></p></li></ul></div><div class="itemizedlist" title="Related Tutorial Sections"><p class="title"><b>Related Tutorial Sections</b></p><ul class="itemizedlist" type="disc"><li class="listitem"><p><a href="../userguide/userguide.html#ug.additional.defclass" class="olink">Defining Classes</a></p></li></ul></div></div></div><script xmlns:od="http://orc.csres.utexas.edu/OrcDocBook.xsd" xmlns:db="http://docbook.org/ns/docbook" type="text/javascript" src="/orchard/orc.js"></script></body></html>