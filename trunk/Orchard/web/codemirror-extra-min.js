/**
 * CodeMirror 0.58 http://marijn.haverbeke.nl/codemirror/
 *
 * This is a minified version created by Adrian Quark for the Orc project:
 * http://orc.csres.utexas.edu. It is otherwise unmodified.
 *
 * ------------ ORIGINAL LICENSE FOLLOWS -----------------
 *
 * Copyright (c) 2007 Marijn Haverbeke
 *
 * This software is provided 'as-is', without any express or implied
 * warranty. In no event will the authors be held liable for any
 * damages arising from the use of this software.
 *
 * Permission is granted to anyone to use this software for any
 * purpose, including commercial applications, and to alter it and
 * redistribute it freely, subject to the following restrictions:
 *
 * 1. The origin of this software must not be misrepresented; you must
 *    not claim that you wrote the original software. If you use this
 *    software in a product, an acknowledgment in the product
 *    documentation would be appreciated but is not required.
 *
 * 2. Altered source versions must be plainly marked as such, and must
 *    not be misrepresented as being the original software.
 *
 * 3. This notice may not be removed or altered from any source
 *    distribution.
 *
 * Marijn Haverbeke
 * marijnh at gmail
 */
var Editor=(function(){var I={P:true,DIV:true,LI:true};function D(P){var O=[],N=true;for(;P>0;P--){O.push((N||P==1)?nbsp:" ");N=!N}return O.join("")}function E(N){if(N==" "){return nbsp}else{return N.replace(/[\t \u00a0]{2,}/g,function(O){return D(O.length)})}}function C(N){return E(N.replace(/\u00a0/g," ")).replace(/\r\n?/g,"\n").split("\n")}var A=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent);function F(O){var Q=O.ownerDocument;var N=[];var R=false;function P(S){if(S.nodeType==3){var T=S.nodeValue=E(S.nodeValue.replace(/[\n\r]/g,""));if(T.length){R=false}N.push(S)}else{if(S.nodeName=="BR"&&S.childNodes.length==0){R=true;N.push(S)}else{forEach(S.childNodes,P);if(!R&&I.hasOwnProperty(S.nodeName)){R=true;N.push(Q.createElement("BR"))}}}}P(O);return N}function G(N){function O(a,b){Q=b;return a}function V(b,a,d){return function(){return b(a,d)}}function W(){Q=W;throw StopIteration}var Q=V(X,N,W);var P=N.ownerDocument;var R=[];function U(c){var b=c.parentNode;var a=c.nextSibling;return function(d){b.insertBefore(d,a)}}var Y=null;function S(a){var c="\n";if(a.nodeType==3){select.moveSelection();c=a.nodeValue;var b=P.createElement("SPAN");b.className="part";b.appendChild(a);a=b;a.currentText=c}a.dirty=true;R.push(a);Y(a);return c}function T(b,d){var a=[];forEach(F(b),function(c){a.push(S(c))});return O(a.join(""),d)}function Z(a){if(a.nodeName=="SPAN"&&a.childNodes.length==1&&a.firstChild.nodeType==3){a.currentText=a.firstChild.nodeValue;return true}return false}function X(a,b){if(a.nextSibling){b=V(X,a.nextSibling,b)}if(Z(a)){R.push(a);return O(a.currentText,b)}else{if(a.nodeName=="BR"){R.push(a);return O("\n",b)}else{Y=U(a);removeElement(a);return T(a,b)}}}return{next:function(){return Q()},nodes:R}}function K(N){if(N.nodeName=="BR"){return 1}else{return N.currentText.length}}function M(N){while(N&&N.nodeName!="BR"){N=N.previousSibling}return N}function J(N){return N.replace(/\u00a0/g," ")}function L(Q,P,O){this.editor=Q;this.history=Q.history;this.history.commit();this.atOccurrence=false;this.fallbackSize=15;var S;if(O&&(S=select.cursorPos(this.editor.container))){this.line=S.node;this.offset=S.offset}else{this.line=null;this.offset=0}this.valid=!!P;var R=P.split("\n"),N=this;this.matches=(R.length==1)?function(){var T=J(N.history.textAfter(N.line).slice(N.offset)).indexOf(P);if(T>-1){return{from:{node:N.line,offset:N.offset+T},to:{node:N.line,offset:N.offset+T+P.length}}}}:function(){var W=J(N.history.textAfter(N.line).slice(N.offset));var V=W.lastIndexOf(R[0]);if(V==-1||V!=W.length-R[0].length){return false}var T=N.offset+V;var U=N.history.nodeAfter(N.line);for(var X=1;X<R.length-1;X++){if(J(N.history.textAfter(U))!=R[X]){return false}U=N.history.nodeAfter(U)}if(J(N.history.textAfter(U)).indexOf(R[R.length-1])!=0){return false}return{from:{node:N.line,offset:T},to:{node:U,offset:R[R.length-1].length}}}}L.prototype={findNext:function(){if(!this.valid){return false}this.atOccurrence=false;var N=this;if(this.line&&!this.line.parentNode){this.line=null;this.offset=0}function P(Q){if(N.history.textAfter(Q.node).length<Q.offset){N.line=Q.node;N.offset=Q.offset+1}else{N.line=N.history.nodeAfter(Q.node);N.offset=0}}while(true){var O=this.matches();if(O){this.atOccurrence=O;P(O.from);return true}this.line=this.history.nodeAfter(this.line);this.offset=0;if(!this.line){this.valid=false;return false}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.atOccurrence.from,this.atOccurrence.to);select.scrollToCursor(this.editor.container)}},replace:function(O){if(this.atOccurrence){var N=this.editor.replaceRange(this.atOccurrence.from,this.atOccurrence.to,O);this.line=N.node;this.offset=N.offset;this.atOccurrence=false}}};function H(O){this.options=O;this.parent=parent;this.doc=document;this.container=this.doc.body;this.win=window;this.history=new History(this.container,this.options.undoDepth,this.options.undoDelay,this,O.onChange);if(!H.Parser){throw"No parser loaded."}if(O.parserConfig&&H.Parser.configure){H.Parser.configure(O.parserConfig)}if(!O.textWrapping){this.container.style.whiteSpace="pre"}select.setCursorPos(this.container,{node:null,offset:0});this.dirty=[];if(O.content){this.importCode(O.content)}else{this.container.appendChild(this.doc.createElement("BR"))}if(!O.readOnly){if(O.continuousScanning!==false){this.scanner=this.documentScanner(O.linesPerPass);this.delayScanning()}function P(){if(document.body.contentEditable!=undefined&&/MSIE/.test(navigator.userAgent)){document.body.contentEditable="true"}else{document.designMode="on"}}try{P()}catch(Q){var N=addEventHandler(document,"focus",function(){removeEventHandler(N);P()})}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));addEventHandler(document.body,"paste",method(this,"markCursorDirty"));addEventHandler(document.body,"cut",method(this,"markCursorDirty"));if(this.options.autoMatchParens){addEventHandler(document.body,"click",method(this,"scheduleParenBlink"))}}}function B(N){return(N>=16&&N<=18)||(N>=33&&N<=40)}H.prototype={importCode:function(N){this.history.push(null,null,C(N));this.history.reset()},getCode:function(){if(!this.container.firstChild){return""}var N=[],O=select.markSelection(this.win);forEach(G(this.container.firstChild),method(N,"push"));select.selectMarked(O);return J(N.join(""))},jumpToLine:function(N){if(N<=1||!this.container.firstChild){select.focusAfterNode(null,this.container)}else{var O=this.container.firstChild;while(true){if(O.nodeName=="BR"){N--}if(N<=1||!O.nextSibling){break}O=O.nextSibling}select.focusAfterNode(O,this.container)}select.scrollToCursor(this.container)},currentLine:function(){var O=select.cursorPos(this.container,true),N=1;if(!O){return 1}for(cursor=O.node;cursor;cursor=cursor.previousSibling){if(cursor.nodeName=="BR"){N++}}return N},selectedText:function(){var O=this.history;O.commit();var Q=select.cursorPos(this.container,true),N=select.cursorPos(this.container,false);if(!Q||!N){return""}if(Q.node==N.node){return O.textAfter(Q.node).slice(Q.offset,N.offset)}var P=[O.textAfter(Q.node).slice(Q.offset)];for(pos=O.nodeAfter(Q.node);pos!=N.node;pos=O.nodeAfter(pos)){P.push(O.textAfter(pos))}P.push(O.textAfter(N.node).slice(0,N.offset));return J(P.join("\n"))},replaceSelection:function(O){this.history.commit();var P=select.cursorPos(this.container,true),N=select.cursorPos(this.container,false);if(!P||!N){return false}N=this.replaceRange(P,N,O);select.setCursorPos(this.container,P,N);return true},replaceRange:function(S,R,Q){var P=C(Q);P[0]=this.history.textAfter(S.node).slice(0,S.offset)+P[0];var O=P[P.length-1];P[P.length-1]=O+this.history.textAfter(R.node).slice(R.offset);var N=this.history.nodeAfter(R.node);this.history.push(S.node,N,P);return{node:this.history.nodeBefore(N),offset:O.length}},getSearchCursor:function(O,N){return new L(this,O,N)},reindent:function(){if(this.container.firstChild){this.indentRegion(null,this.container.lastChild)}},keyDown:function(N){this.delayScanning();if(this.options.autoMatchParens){this.scheduleParenBlink()}if(N.keyCode==13){if(N.ctrlKey){this.reparseBuffer()}else{select.insertNewlineAtCursor(this.win);this.indentAtCursor();select.scrollToCursor(this.container)}N.stop()}else{if(N.keyCode==9){this.handleTab();N.stop()}else{if(N.ctrlKey){if(N.keyCode==90||N.keyCode==8){this.history.undo();N.stop()}else{if(N.keyCode==89){this.history.redo();N.stop()}else{if(N.keyCode==83&&this.options.saveFunction){this.options.saveFunction();N.stop()}}}}}}},keyPress:function(O){var N=H.Parser.electricChars;if(O.code==13||O.code==9){O.stop()}else{if((O.character=="["||O.character=="]")&&O.ctrlKey){O.stop(),this.blinkParens()}else{if(N&&N.indexOf(O.character)!=-1){this.parent.setTimeout(method(this,"indentAtCursor"),0)}}}},keyUp:function(N){if(A){this.container.createTextRange().execCommand("unlink")}if(!B(N.keyCode)){this.markCursorDirty()}},indentLineAfter:function(S){var R=S?S.nextSibling:this.container.firstChild;if(R&&!hasClass(R,"whitespace")){R=null}var O=R?R.nextSibling:(S?S.nextSibling:this.container.firstChild);var P=(S&&O&&O.currentText)?O.currentText:"";var N=S?S.indentation(P):0;var Q=N-(R?R.currentText.length:0);if(Q<0){if(N==0){removeElement(R);R=null}else{R.currentText=D(N);R.firstChild.nodeValue=R.currentText}}else{if(Q>0){if(R){R.currentText=D(N);R.firstChild.nodeValue=R.currentText}else{R=this.doc.createElement("SPAN");R.className="part whitespace";R.appendChild(this.doc.createTextNode(D(N)));if(S){insertAfter(R,S)}else{this.container.insertBefore(R,this.container.firstChild)}}}}return R},highlightAtCursor:function(){var R=select.selectionTopNode(this.container,true);var Q=select.selectionTopNode(this.container,false);if(R===false||!Q){return }if(Q.nextSibling){Q=Q.nextSibling}var P=select.markSelection(this.win);var O=Q.nodeType==3;if(!O){Q.dirty=true}while(Q.parentNode==this.container&&(O||Q.dirty)){var N=this.highlight(R,1,true);if(N){R=N.node}if(!N||N.left){break}}select.selectMarked(P)},handleTab:function(){if(this.options.dumbTabs){select.insertTabAtCursor(this.win)}else{var O=select.selectionTopNode(this.container,true),N=select.selectionTopNode(this.container,false);if(O===false||N===false){return }if(O==N){this.indentAtCursor()}else{this.indentRegion(O,N)}}},scheduleParenBlink:function(){if(this.parenEvent){this.parent.clearTimeout(this.parenEvent)}this.parenEvent=this.parent.setTimeout(method(this,"blinkParens"),300)},blinkParens:function(){if(this.parenEvent){this.parent.clearTimeout(this.parenEvent)}this.parenEvent=null;function U(Z){if(Z.currentText){var Y=Z.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return Y&&Y[1]}}function Q(Y){return/[\(\[\{]/.test(Y)}this.highlightAtCursor();var V=select.selectionTopNode(this.container,true),N,W=this;if(!V||!(N=U(V))){return }var T=V.className,P=Q(N),R=matching[N];function S(){var Y=[],a,Z=true;for(var b=V;b;b=P?b.nextSibling:b.previousSibling){if(b.className==T&&b.nodeName=="SPAN"&&(a=U(b))){if(Q(a)==P){Y.push(a)}else{if(!Y.length){Z=false}else{if(Y.pop()!=matching[a]){Z=false}}}if(!Y.length){break}}else{if(b.dirty||b.nodeName!="SPAN"&&b.nodeName!="BR"){return{node:b,status:"dirty"}}}}return{node:b,status:b&&Z}}function O(Z,Y){Z.style.fontWeight="bold";Z.style.color=Y?"#8F8":"#F88";W.parent.setTimeout(function(){Z.style.fontWeight="";Z.style.color=""},500)}while(true){var X=S();if(X.status=="dirty"){this.highlight(X.node,1);X.node.dirty=false;continue}else{O(V,X.status);if(X.node){O(X.node,X.status)}break}}},indentAtCursor:function(){if(!this.container.firstChild){return }this.highlightAtCursor();var P=select.selectionTopNode(this.container,false);if(P===false){return }var N=M(P);var O=this.indentLineAfter(N);if(P==N&&O){P=O}if(P==O){select.focusAfterNode(P,this.container)}},indentRegion:function(R,O){var Q=select.markSelection(this.win);if(!R){this.indentLineAfter(R)}else{R=M(R.previousSibling)}O=M(O);while(true){var N=this.highlight(R,1);var P=N?N.node:null;while(R!=P){R=R?R.nextSibling:this.container.firstChild}if(P){this.indentLineAfter(P)}if(R==O){break}}select.selectMarked(Q)},markCursorDirty:function(){var N=select.selectionTopNode(this.container,false);if(N!==false&&this.container.firstChild){this.scheduleHighlight();this.addDirtyNode(N||this.container.firstChild)}},reparseBuffer:function(){forEach(this.container.childNodes,function(N){N.dirty=true});if(this.container.firstChild){this.addDirtyNode(this.container.firstChild)}},addDirtyNode:function(O){O=O||this.container.firstChild;if(!O){return }for(var N=0;N<this.dirty.length;N++){if(this.dirty[N]==O){return }}if(O.nodeType!=3){O.dirty=true}this.dirty.push(O)},scheduleHighlight:function(){var N=this;this.parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=this.parent.setTimeout(function(){N.highlightDirty()},this.options.passDelay)},getDirtyNode:function(){while(this.dirty.length>0){var N=this.dirty.pop();try{if((N.dirty||N.nodeType==3)&&N.parentNode){return N}}catch(O){}}return null},highlightDirty:function(Q){var O=Q?Infinity:this.options.linesPerPass;var P=select.markSelection(this.win);var R;while(O>0&&(R=this.getDirtyNode())){var N=this.highlight(R,O);if(N){O=N.left;if(N.node&&N.dirty){this.addDirtyNode(N.node)}}}select.selectMarked(P);if(R){this.scheduleHighlight()}return this.dirty.length==0},documentScanner:function(N){var O=this,P=null;return function(){if(P&&P.parentNode!=O.container){P=null}var R=select.markSelection(O.win);var Q=O.highlight(P,N,true);select.selectMarked(R);P=Q?(Q.node&&Q.node.nextSibling):null;O.delayScanning()}},delayScanning:function(){if(this.scanner){this.parent.clearTimeout(this.documentScan);this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(W,a,R){var O=this.container,Y=this;if(!O.firstChild){return }while(W&&(!W.parserFromHere||W.dirty)){W=W.previousSibling}if(W&&!W.nextSibling){return }function N(c,b){return !b.reduced&&b.currentText==c.value&&b.className=="part "+c.style}function Z(b,c){b.currentText=b.currentText.substring(c);b.reduced=true}function P(c){var b=Y.doc.createElement("SPAN");b.className="part "+c.style;b.appendChild(Y.doc.createTextNode(c.value));b.currentText=c.value;return b}var U=G(W?W.nextSibling:O.firstChild),X=stringStream(U),V=W?W.parserFromHere(X):H.Parser.make(X);var Q={current:null,get:function(){if(!this.current){this.current=U.nodes.shift()}return this.current},next:function(){this.current=null},remove:function(){O.removeChild(this.get());this.current=null},getNonEmpty:function(){var c=this.get();while(c&&c.nodeName=="SPAN"&&c.currentText==""){var b=c;this.remove();c=this.get();select.moveSelection(b.firstChild,c.firstChild||c,0,0)}return c}};var T=false,S=0;forEach(V,function(d){var c=Q.getNonEmpty();if(d.value=="\n"){if(c.nodeName!="BR"){throw"Parser out of sync. Expected BR."}if(c.dirty||!c.indentation){T=true}if(T){Y.history.touch(W)}W=c;c.parserFromHere=V.copy();c.indentation=d.indentation;c.dirty=false;if((a!==undefined&&--a<=0)||(!T&&S>1&&!R)){throw StopIteration}T=false;S=0;Q.next()}else{if(c.nodeName!="SPAN"){throw"Parser out of sync. Expected SPAN."}if(c.dirty){T=true}S++;if(N(d,c)){c.dirty=false;Q.next()}else{T=true;var b=P(d);O.insertBefore(b,c);var g=d.value.length;var f=0;while(g>0){c=Q.get();var e=c.currentText.length;select.moveSelection(c.firstChild,b.firstChild,g,f);if(e>g){Z(c,g);g=0}else{g-=e;f+=e;Q.remove()}}}}});if(T){this.history.touch(W)}return{left:a,node:Q.get(),dirty:T}}};return H})();addEventHandler(window,"load",function(){var A=window.frameElement.CodeMirror;A.editor=new Editor(A.options);if(A.options.initCallback){this.parent.setTimeout(function(){A.options.initCallback(A)},0)}});var select={};(function(){var C=document.selection&&document.selection.createRangeCollection;function D(J,K){while(J&&J.parentNode!=K){J=J.parentNode}return J}function I(J,K){while(!J.previousSibling&&J.parentNode!=K){J=J.parentNode}return D(J.previousSibling,K)}var H=false;var E="\u00a0\u00a0\u00a0\u00a0";if(C){select.markSelection=function(N){var M=N.document.selection;var O=M.createRange(),K=O.duplicate();var L=O.getBookmark();O.collapse(true);K.collapse(false);H=false;var J=N.document.body;return{start:{x:O.boundingLeft+J.scrollLeft-1,y:O.boundingTop+J.scrollTop},end:{x:K.boundingLeft+J.scrollLeft-1,y:K.boundingTop+J.scrollTop},window:N,bookmark:L}};select.selectMarked=function(M){if(!M||!H){return }H=false;var L=M.window.document.body.createTextRange(),J=L.duplicate();var K=false;if(M.start.y>=0&&M.end.y<M.window.document.body.clientHeight){try{L.moveToPoint(M.start.x,M.start.y);J.moveToPoint(M.end.x,M.end.y);L.setEndPoint("EndToStart",J);K=true}catch(N){}}if(!K){K=L.moveToBookmark(M.bookmark)}if(K){L.select()}};select.moveSelection=function(){H=true};select.selectionTopNode=function(L,Q){var O=L.ownerDocument.selection;if(!O){return false}var N=O.createRange();N.collapse(Q);var P=N.parentElement();if(P&&isAncestor(L,P)){var K=N.duplicate();K.moveToElementText(P);if(N.compareEndPoints("StartToStart",K)==-1){return D(P,L)}}N.pasteHTML("<span id='xxx-temp-xxx'></span>");var M=L.ownerDocument.getElementById("xxx-temp-xxx");if(M){var J=I(M,L);removeElement(M);return J}return false};select.focusAfterNode=function(L,J){var K=J.ownerDocument.body.createTextRange();K.moveToElementText(L||J);K.collapse(!L);K.select()};function B(M,K){var L=M.document.selection;if(L){var J=L.createRange();J.pasteHTML(K);J.collapse(false);J.select()}}select.insertNewlineAtCursor=function(J){B(J,"<br/>")};select.insertTabAtCursor=function(J){B(J,E)};select.cursorPos=function(K,P){var N=K.ownerDocument.selection;if(!N){return null}var M=select.selectionTopNode(K,P);while(M&&M.nodeName!="BR"){M=M.previousSibling}var L=N.createRange(),J=L.duplicate();L.collapse(P);if(M){J.moveToElementText(M);J.collapse(false)}else{try{J.moveToElementText(K)}catch(O){return null}J.collapse(true)}L.setEndPoint("StartToStart",J);return{node:M,offset:L.text.length}};select.setCursorPos=function(K,N,M){function J(P){var O=K.ownerDocument.body.createTextRange();if(!P.node){O.moveToElementText(K);O.collapse(true)}else{O.moveToElementText(P.node);O.collapse(false)}O.move("character",P.offset);return O}var L=J(N);if(M&&M!=N){L.setEndPoint("EndToEnd",J(M))}L.select()};select.scrollToCursor=function(J){var K=J.ownerDocument.selection;if(!K){return null}K.createRange().scrollIntoView()}}else{var G=!window.scrollX&&!window.scrollY;select.markSelection=function(N){H=false;var M=N.getSelection();if(!M||M.rangeCount==0){return null}var L=M.getRangeAt(0);var J={start:{node:L.startContainer,offset:L.startOffset},end:{node:L.endContainer,offset:L.endOffset},window:N,scrollX:G&&N.document.body.scrollLeft,scrollY:G&&N.document.body.scrollTop};function K(O){while(O.node.nodeType!=3&&O.node.nodeName!="BR"){var P=O.node.childNodes[O.offset]||O.node.nextSibling;O.offset=0;while(!P&&O.node.parentNode){O.node=O.node.parentNode;P=O.node.nextSibling}O.node=P;if(!P){break}}}K(J.start);K(J.end);if(J.start.node){J.start.node.selectStart=J.start}if(J.end.node){J.end.node.selectEnd=J.end}return J};select.selectMarked=function(L){if(!L||!H){return }var M=L.window;var K=M.document.createRange();function J(N,O){if(N.node){delete N.node["select"+O];if(N.offset==0){K["set"+O+"Before"](N.node)}else{K["set"+O](N.node,N.offset)}}else{K.setStartAfter(M.document.body.lastChild||M.document.body)}}if(G){L.window.document.body.scrollLeft=L.scrollX;L.window.document.body.scrollTop=L.scrollY}J(L.end,"End");J(L.start,"Start");F(K,M)};select.moveSelection=function(M,K,L,N){H=true;if(M==undefined){return }function J(P){var O=M["select"+P];if(O){if(O.offset>L){O.offset-=L}else{K["select"+P]=O;delete M["select"+P];O.node=K;O.offset+=(N||0)}}}J("Start");J("End")};function F(J,L){var K=L.getSelection();K.removeAllRanges();K.addRange(J)}function A(K){var J=K.getSelection();if(!J||J.rangeCount==0){return false}else{return J.getRangeAt(0)}}select.selectionTopNode=function(J,N){var K=A(J.ownerDocument.defaultView);if(!K){return false}var L=N?K.startContainer:K.endContainer;var M=N?K.startOffset:K.endOffset;if(window.opera&&!N&&K.endContainer==J&&K.endOffset==K.startOffset+1&&J.childNodes[K.startOffset]&&J.childNodes[K.startOffset].nodeName=="BR"){M--}if(L.nodeType==3){if(M>0){return D(L,J)}else{return I(L,J)}}else{if(L.nodeName=="HTML"){return(M==1?null:J.lastChild)}else{if(L==J){return(M==0)?null:L.childNodes[M-1]}else{if(M==L.childNodes.length){return D(L,J)}else{if(M==0){return I(L,J)}else{return D(L.childNodes[M-1],J)}}}}}};select.focusAfterNode=function(L,J){var M=J.ownerDocument.defaultView,K=M.document.createRange();K.setStartBefore(J.firstChild||J);if(L&&!L.firstChild){K.setEndAfter(L)}else{if(L){K.setEnd(L,L.childNodes.length)}else{K.setEndBefore(J.firstChild||J)}}K.collapse(false);F(K,M)};insertNodeAtCursor=function(L,K){var J=A(L);if(!J){return }J.deleteContents();J.insertNode(K);J.setEndAfter(K);J.collapse(false);F(J,L);return K};select.insertNewlineAtCursor=function(J){insertNodeAtCursor(J,J.document.createElement("BR"))};select.insertTabAtCursor=function(J){insertNodeAtCursor(J,J.document.createTextNode(E))};select.cursorPos=function(J,M){var K=A(window);if(!K){return }var L=select.selectionTopNode(J,M);while(L&&L.nodeName!="BR"){L=L.previousSibling}K=K.cloneRange();K.collapse(M);if(L){K.setStartAfter(L)}else{K.setStartBefore(J)}return{node:L,offset:K.toString().length}};select.setCursorPos=function(J,O,N){var M=J.ownerDocument.defaultView,L=M.document.createRange();function K(S,V,Q){if(!S){S=J.firstChild}else{S=S.nextSibling}if(!S){return }if(V==0){L["set"+Q+"Before"](S);return true}var T=[];function P(W){if(W.nodeType==3){T.push(W)}else{forEach(W.childNodes,P)}}while(true){while(S&&!T.length){P(S);S=S.nextSibling}var U=T.shift();if(!U){return false}var R=U.nodeValue.length;if(R>=V){L["set"+Q](U,V);return true}V-=R}}N=N||O;if(K(N.node,N.offset,"End")&&K(O.node,O.offset,"Start")){F(L,M)}};select.scrollToCursor=function(L){var K=L.ownerDocument.body,N=L.ownerDocument.defaultView;var M=select.selectionTopNode(L,true)||L.firstChild;while(M&&!M.offsetTop){M=M.previousSibling}var P=0,O=M;while(O&&O.offsetParent){P+=O.offsetTop;O=O.offsetParent}var J=P-K.scrollTop;if(J<0||J>N.innerHeight-10){N.scrollTo(0,P)}}}}());(function(){var A={more:function(){return this.peek()!==null},applies:function(C){var B=this.peek();return(B!==null&&C(B))},nextWhile:function(B){while(this.applies(B)){this.next()}},equals:function(B){return B===this.peek()},endOfLine:function(){var B=this.peek();return B==null||B=="\n"},matches:function(C,B){for(var D=0;D<C.length;D++){var E=this.peek();if(!E||C.charAt(D)!=(B?E:E.toLowerCase())){return false}this.next()}return true}};window.stringStream=function(C){C=iter(C);var D="",F=0;var E=null,B="";return update({peek:function(){if(!E){try{E=this.step()}catch(G){if(G!=StopIteration){throw G}else{E=null}}}return E},step:function(){if(E){var G=E;E=null;return G}while(F==D.length){B+=D;D="";F=0;D=C.next()}return D.charAt(F++)},next:function(){try{return this.step()}catch(G){if(G==StopIteration&&B.length>0){throw"End of stringstream reached without emptying buffer ('"+B+"')."}else{throw G}}},get:function(){var G=B;var H=E?F-1:F;B="";if(H>0){G+=D.slice(0,H);D=D.slice(H);F=E?1:0}return G},reset:function(){D=B+D;B="";F=0;E=null},push:function(G){D=D.slice(0,F)+G+D.slice(F)}},A)}})();function tokenizer(D,C){function B(E){return E!="\n"&&/^[\s\u00a0]*$/.test(E)}var A={state:C,take:function(E){if(typeof (E)=="string"){E={style:E,type:E}}E.content=(E.content||"")+D.get();if(!/\n$/.test(E.content)){D.nextWhile(B)}E.value=E.content+D.get();return E},next:function(){if(!D.more()){throw StopIteration}var E;if(D.equals("\n")){D.next();return this.take("whitespace")}if(D.applies(B)){E="whitespace"}else{while(!E){E=this.state(D,function(F){A.state=F})}}return this.take(E)}};return A}function History(B,F,A,E,C){this.container=B;this.maxDepth=F;this.commitDelay=A;this.editor=E;this.parent=E.parent;this.onChange=C;var D={text:"",from:null,to:null};this.first=D;this.last=D;this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[]}History.prototype={scheduleCommit:function(){this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(method(this,"tryCommit"),this.commitDelay)},touch:function(A){this.setTouched(A);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){this.redoHistory.push(this.updateTo(this.history.pop(),"applyChain"));if(this.onChange){this.onChange()}}},redo:function(){this.commit();if(this.redoHistory.length){this.addUndoLevel(this.updateTo(this.redoHistory.pop(),"applyChain"));if(this.onChange){this.onChange()}}},push:function(F,E,B){var D=[];for(var C=0;C<B.length;C++){var A=(C==B.length-1)?E:this.container.ownerDocument.createElement("BR");D.push({from:F,to:A,text:B[C]});F=A}this.pushChains([D],F==null&&E==null)},pushChains:function(B,A){this.commit(A);this.addUndoLevel(this.updateTo(B,"applyChain"));this.redoHistory=[]},reset:function(){this.history=[];this.redoHistory=[]},textAfter:function(A){return this.after(A).text},nodeAfter:function(A){return this.after(A).to},nodeBefore:function(A){return this.before(A).from},tryCommit:function(){if(this.editor.highlightDirty()){this.commit()}else{this.scheduleCommit()}},commit:function(B){this.parent.clearTimeout(this.commitTimeout);if(!B){this.editor.highlightDirty(true)}var C=this.touchedChains(),A=this;if(C.length){this.addUndoLevel(this.updateTo(C,"linkChain"));this.redoHistory=[];if(this.onChange){this.onChange()}}},updateTo:function(E,A){var D=[],C=[];for(var B=0;B<E.length;B++){D.push(this.shadowChain(E[B]));C.push(this[A](E[B]))}if(A=="applyChain"){this.notifyDirty(C)}return D},notifyDirty:function(A){forEach(A,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},linkChain:function(C){for(var B=0;B<C.length;B++){var A=C[B];if(A.from){A.from.historyAfter=A}else{this.first=A}if(A.to){A.to.historyBefore=A}else{this.last=A}}},after:function(A){return A?A.historyAfter:this.first},before:function(A){return A?A.historyBefore:this.last},setTouched:function(A){if(A){if(!A.historyTouched){this.touched.push(A);A.historyTouched=true}}else{this.firstTouched=true}},addUndoLevel:function(A){this.history.push(A);if(this.history.length>this.maxDepth){this.history.shift()}},touchedChains:function(){var C=this;function H(J,I){return J.replace(/\u00a0/g," ")==I.replace(/\u00a0/g," ")}var D=null;function B(I){return I?I.historyTemp:D}function E(J,I){if(J){J.historyTemp=I}else{D=I}}var A=[];if(C.firstTouched){C.touched.push(null)}forEach(C.touched,function(J){if(J){J.historyTouched=false;if(J.parentNode!=C.container){return }}else{C.firstTouched=false}var L=[];for(var K=J?J.nextSibling:C.container.firstChild;K&&K.nodeName!="BR";K=K.nextSibling){if(K.currentText){L.push(K.currentText)}}var I={from:J,to:K,text:L.join("")};var M=C.after(J);if(!M||!H(M.text,I.text)||M.to!=I.to){A.push(I);E(J,I)}});function G(L,I){var K=I+"Sibling",J=L[K];while(J&&J.nodeName!="BR"){J=J[K]}return J}var F=[];C.touched=[];forEach(A,function(J){if(!B(J.from)){return }var K=[],L=J.from;while(true){var I=B(L);if(!I){break}K.unshift(I);E(L,null);if(!L){break}L=G(L,"previous")}L=J.to;while(true){var I=B(L);if(!I||!L){break}K.push(I);E(L,null);L=G(L,"next")}if(C.after(K[0].from)&&C.before(K[K.length-1].to)){F.push(K)}else{forEach(K,function(M){C.setTouched(M.from)})}});return F},shadowChain:function(C){var E=[],D=this.after(C[0].from),B=C[C.length-1].to;while(true){E.push(D);var A=D.to;if(!A||A==B){break}else{D=A.historyAfter}}return E},applyChain:function(A){var J=select.cursorPos(this.container,false),L=this;function B(Q,P){var O=Q?Q.nextSibling:L.container.firstChild;while(O!=P){var N=O.nextSibling;removeElement(O);O=N}}var C=A[0].from,G=A[A.length-1].to;B(C,G);var K=G?function(N){L.container.insertBefore(N,G)}:function(N){L.container.appendChild(N)};for(var H=0;H<A.length;H++){var M=A[H];if(H>0){K(M.from)}var F=this.container.ownerDocument.createTextNode(M.text);K(F);if(J&&J.node==M.from){var E=0;var D=this.after(M.from);if(D&&H==A.length-1){for(var I=0;I<J.offset&&M.text.charAt(I)==D.text.charAt(I);I++){}if(J.offset>I){E=M.text.length-D.text.length}}select.setCursorPos(this.container,{node:M.from,offset:Math.max(0,J.offset+E)})}else{if(J&&(H==A.length-1)&&J.node&&J.node.parentNode!=this.container){select.setCursorPos(this.container,{node:M.from,offset:M.text.length})}}}this.linkChain(A);return C}};function method(B,A){return function(){B[A].apply(B,arguments)}}function update(B,C){for(var A in C){B[A]=C[A]}return B}var StopIteration={toString:function(){return"StopIteration"}};function iter(A){var B=0;if(A.next){return A}else{return{next:function(){if(B>=A.length){throw StopIteration}else{return A[++B]}}}}}function forEach(A,C){if(A.next){try{while(true){C(A.next())}}catch(D){if(D!=StopIteration){throw D}}}else{for(var B=0;B<A.length;B++){C(A[B])}}}function map(A,C){var B=[];forEach(A,function(D){B.push(C(D))});return B}function matcher(A){return function(B){return A.test(B)}}function hasClass(B,C){var A=B.className;return A&&new RegExp("(^| )"+C+"($| )").test(A)}function insertAfter(A,C){var B=C.parentNode;B.insertBefore(A,C.nextSibling);return A}function removeElement(A){if(A.parentNode){A.parentNode.removeChild(A)}}function clearElement(A){while(A.firstChild){A.removeChild(A.firstChild)}}function isAncestor(A,B){while(B=B.parentNode){if(A==B){return true}}return false}var nbsp="\u00a0";var matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("};function normalizeEvent(A){if(!A.stopPropagation){A.stopPropagation=function(){this.cancelBubble=true};A.preventDefault=function(){this.returnValue=false}}if(!A.stop){A.stop=function(){this.stopPropagation();this.preventDefault()}}if(A.type=="keypress"){if(A.charCode===0||A.charCode==undefined){A.code=A.keyCode}else{A.code=A.charCode}A.character=String.fromCharCode(A.code)}return A}function addEventHandler(C,B,A){function D(E){A(normalizeEvent(E||window.event))}if(typeof C.addEventListener=="function"){C.addEventListener(B,D,false);return function(){C.removeEventListener(B,D,false)}}else{C.attachEvent("on"+B,D);return function(){C.detachEvent("on"+B,D)}}}function removeEventHandler(A){A()};