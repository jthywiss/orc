/*
Copyright (c) 2007 Marijn Haverbeke

This software is provided 'as-is', without any express or implied
warranty. In no event will the authors be held liable for any
damages arising from the use of this software.

Permission is granted to anyone to use this software for any
purpose, including commercial applications, and to alter it and
redistribute it freely, subject to the following restrictions:

1. The origin of this software must not be misrepresented; you must
   not claim that you wrote the original software. If you use this
   software in a product, an acknowledgment in the product
   documentation would be appreciated but is not required.

2. Altered source versions must be plainly marked as such, and must
   not be misrepresented as being the original software.

3. This notice may not be removed or altered from any source
   distribution.

Marijn Haverbeke
marijnh at gmail

ATTENTION: this version has been minified and combined into
a single file by Adrian Quark, but is otherwise unaltered.
*/
var Editor=(function(){var B={P:true,DIV:true,LI:true};function D(O){var N=[],M=true;for(;O>0;O--){N.push((M||O==1)?nbsp:" ");M=!M}return N.join("")}function E(M){return M.replace(/[\t \u00a0]{2,}/g,function(N){return D(N.length)})}function C(M){return E(M.replace(/\u00a0/g," ")).replace(/\r\n?/g,"\n").split("\n")}function F(P){var Q=P.ownerDocument;var O=[];var M=false;function N(R){if(R.nodeType==3){var S=R.nodeValue=E(R.nodeValue.replace(/[\n\r]/g,""));if(S.length){M=false}O.push(R)}else{if(R.nodeName=="BR"&&R.childNodes.length==0){M=false;O.push(R)}else{forEach(R.childNodes,N);if(!M&&B.hasOwnProperty(R.nodeName)){M=true;O.push(Q.createElement("BR"))}}}}N(P);return O}function G(Y){function M(Z,a){N=a;return Z}function S(a,Z,b){return function(){return a(Z,b)}}function U(){N=U;throw StopIteration}var N=S(W,Y,U);var V=Y.ownerDocument;var T=[];function R(b){var a=b.parentNode;var Z=b.nextSibling;if(Z){return function(c){a.insertBefore(c,Z)}}else{return function(c){a.appendChild(c)}}}var Q=null;function O(b){var a="\n";if(b.nodeType==3){a=b.nodeValue;var Z=V.createElement("SPAN");Z.className="part";Z.appendChild(b);b=Z;b.currentText=a}b.dirty=true;T.push(b);Q(b);return a}function P(a,b){var Z=[];forEach(F(a),function(c){Z.push(O(c))});return M(Z.join(""),b)}function X(Z){if(Z.nodeName=="SPAN"&&Z.childNodes.length==1&&Z.firstChild.nodeType==3){Z.currentText=Z.firstChild.nodeValue;return true}return false}function W(Z,a){if(Z.nextSibling){a=S(W,Z.nextSibling,a)}if(X(Z)){T.push(Z);return M(Z.currentText,a)}else{if(Z.nodeName=="BR"){T.push(Z);return M("\n",a)}else{Q=R(Z);removeElement(Z);return P(Z,a)}}}return{next:function(){return N()},nodes:T}}function J(M){if(M.nodeName=="BR"){return 1}else{return M.currentText.length}}function L(M){while(M&&M.nodeName!="BR"){M=M.previousSibling}return M}function I(M){return M.replace(/\u00a0/g," ")}function K(Q,O,N){this.editor=Q;this.history=Q.history;this.history.commit();this.atOccurrence=false;this.fallbackSize=15;var M;if(N&&(M=select.cursorPos(this.editor.container))){this.line=M.node;this.offset=M.offset}else{this.line=null;this.offset=0}this.valid=!!O;var R=O.split("\n"),P=this;this.matches=(R.length==1)?function(){var S=I(P.history.textAfter(P.line).slice(P.offset)).indexOf(O);if(S>-1){return{from:{node:P.line,offset:P.offset+S},to:{node:P.line,offset:P.offset+S+O.length}}}}:function(){var W=I(P.history.textAfter(P.line).slice(P.offset));var U=W.lastIndexOf(R[0]);if(U==-1||U!=W.length-R[0].length){return false}var V=P.offset+U;var T=P.history.nodeAfter(P.line);for(var S=1;S<R.length-1;S++){if(I(P.history.textAfter(T))!=R[S]){return false}T=P.history.nodeAfter(T)}if(I(P.history.textAfter(T)).indexOf(R[R.length-1])!=0){return false}return{from:{node:P.line,offset:V},to:{node:T,offset:R[R.length-1].length}}}}K.prototype={findNext:function(){if(!this.valid){return false}this.atOccurrence=false;var O=this;if(this.line&&!this.line.parentNode){this.line=null;this.offset=0}function N(P){if(O.history.textAfter(P.node).length<P.offset){O.line=P.node;O.offset=P.offset+1}else{O.line=O.history.nodeAfter(P.node);O.offset=0}}while(true){var M=this.matches();if(M){this.atOccurrence=M;N(M.from);return true}this.line=this.history.nodeAfter(this.line);this.offset=0;if(!this.line){this.valid=false;return false}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.atOccurrence.from,this.atOccurrence.to);select.scrollToCursor(this.editor.container)}},replace:function(M){if(this.atOccurrence){this.editor.replaceRange(this.atOccurrence.from,this.atOccurrence.to,M);this.line=this.atOccurrence.from.node;this.offset=this.atOccurrence.from.offset;this.atOccurrence=false}}};function H(M){this.options=M;this.parent=parent;this.doc=document;this.container=this.doc.body;this.win=window;this.history=new History(this.container,this.options.undoDepth,this.options.undoDelay,this);if(!H.Parser){throw"No parser loaded."}if(M.parserConfig&&H.Parser.configure){H.Parser.configure(M.parserConfig)}if(!M.textWrapping){this.container.style.whiteSpace="pre"}select.setCursorPos(this.container,{node:null,offset:0});this.dirty=[];if(M.content){this.importCode(M.content)}else{this.container.appendChild(this.doc.createElement("SPAN"))}if(!M.readOnly){if(M.continuousScanning!==false){this.scanner=this.documentScanner(M.linesPerPass);this.delayScanning()}function N(){if(document.body.contentEditable!=undefined&&/MSIE/.test(navigator.userAgent)){document.body.contentEditable="true"}else{document.designMode="on"}}try{N()}catch(O){var P=addEventHandler(document,"focus",function(){removeEventHandler(P);N()})}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));addEventHandler(document.body,"paste",method(this,"markCursorDirty"));addEventHandler(document.body,"cut",method(this,"markCursorDirty"))}}function A(M){return(M>=16&&M<=18)||(M>=33&&M<=40)}H.prototype={importCode:function(M){this.history.push(null,null,C(M));this.history.reset()},getCode:function(){if(!this.container.firstChild){return""}var M=[];forEach(G(this.container.firstChild),method(M,"push"));return I(M.join(""))},jumpToLine:function(M){if(M<=1||!this.container.firstChild){select.focusAfterNode(null,this.container)}else{var N=this.container.firstChild;while(true){if(N.nodeName=="BR"){M--}if(M<=1||!N.nextSibling){break}N=N.nextSibling}select.focusAfterNode(N,this.container)}select.scrollToCursor(this.container)},currentLine:function(){var N=select.cursorPos(this.container,true),M=1;if(!N){return 1}for(cursor=N.node;cursor;cursor=cursor.previousSibling){if(cursor.nodeName=="BR"){M++}}return M},selectedText:function(){var N=this.history;N.commit();var P=select.cursorPos(this.container,true),M=select.cursorPos(this.container,false);if(!P||!M){return""}if(P.node==M.node){return N.textAfter(P.node).slice(P.offset,M.offset)}var O=[N.textAfter(P.node).slice(P.offset)];for(pos=N.nodeAfter(P.node);pos!=M.node;pos=N.nodeAfter(pos)){O.push(N.textAfter(pos))}O.push(N.textAfter(M.node).slice(0,M.offset));return I(O.join("\n"))},replaceSelection:function(O){this.history.commit();var N=select.cursorPos(this.container,true),M=select.cursorPos(this.container,false);if(!N||!M){return false}M=this.replaceRange(N,M,O);select.setCursorPos(this.container,N,M);return true},replaceRange:function(O,R,M){var Q=C(M);Q[0]=this.history.textAfter(O.node).slice(0,O.offset)+Q[0];var P=Q[Q.length-1];Q[Q.length-1]=P+this.history.textAfter(R.node).slice(R.offset);var N=this.history.nodeAfter(R.node);this.history.push(O.node,N,Q);return{node:this.history.nodeBefore(N),offset:P.length}},getSearchCursor:function(N,M){return new K(this,N,M)},reindent:function(){if(this.container.firstChild){this.indentRegion(null,this.container.lastChild)}},keyDown:function(M){this.delayScanning();if(M.keyCode==13){if(M.ctrlKey){this.reparseBuffer()}else{select.insertNewlineAtCursor(this.win);this.indentAtCursor();select.scrollToCursor(this.container)}M.stop()}else{if(M.keyCode==9){this.handleTab();M.stop()}else{if(M.ctrlKey){if(M.keyCode==90||M.keyCode==8){this.history.undo();M.stop()}else{if(M.keyCode==89){this.history.redo();M.stop()}else{if(M.keyCode==83&&this.options.saveFunction){this.options.saveFunction();M.stop()}}}}}}},keyPress:function(M){var N=H.Parser.electricChars;if(M.code==13||M.code==9){M.stop()}else{if(N&&N.indexOf(M.character)!=-1){this.parent.setTimeout(method(this,"indentAtCursor"),0)}}},keyUp:function(M){if(!A(M.keyCode)){this.markCursorDirty()}},indentLineAfter:function(R){var Q=R?R.nextSibling:this.container.firstChild;if(Q&&!hasClass(Q,"whitespace")){Q=null}var P=Q?Q.nextSibling:(R?R.nextSibling:this.container.firstChild);var O=(R&&P&&P.currentText)?P.currentText:"";var N=R?R.indentation(O):0;var M=N-(Q?Q.currentText.length:0);if(M<0){if(N==0){removeElement(Q);Q=null}else{Q.currentText=D(N);Q.firstChild.nodeValue=Q.currentText}}else{if(M>0){if(Q){Q.currentText=D(N);Q.firstChild.nodeValue=Q.currentText}else{Q=this.doc.createElement("SPAN");Q.className="part whitespace";Q.appendChild(this.doc.createTextNode(D(N)));if(R){insertAfter(Q,R)}else{insertAtStart(Q,this.containter)}}}}return Q},highlightAtCursor:function(){var Q=select.selectionTopNode(this.container,true);var P=select.selectionTopNode(this.container,false);if(Q===false||!P){return }if(P.nextSibling){P=P.nextSibling}var O=select.markSelection(this.win);var N=P.nodeType==3;if(!N){P.dirty=true}while(P.parentNode==this.container&&(N||P.dirty)){var M=this.highlight(Q,1,true);if(M){Q=M.node}if(!M||M.left){break}}select.selectMarked(O)},handleTab:function(){var N=select.selectionTopNode(this.container,true),M=select.selectionTopNode(this.container,false);if(N===false||M===false){return }if(N==M){this.indentAtCursor()}else{this.indentRegion(N,M)}},indentAtCursor:function(){if(!this.container.firstChild){return }this.highlightAtCursor();var O=select.selectionTopNode(this.container,false);if(O===false){return }var N=L(O);var M=this.indentLineAfter(N);if(O==N&&M){O=M}if(O==M){select.focusAfterNode(O,this.container)}},indentRegion:function(Q,M){var P=select.markSelection(this.win);if(!Q){this.indentLineAfter(Q)}else{Q=L(Q.previousSibling)}M=L(M);while(true){var O=this.highlight(Q,1);var N=O?O.node:null;while(Q!=N){Q=Q?Q.nextSibling:this.container.firstChild}if(N){this.indentLineAfter(N)}if(Q==M){break}}select.selectMarked(P)},markCursorDirty:function(){var M=select.selectionTopNode(this.container,false);if(M!==false&&this.container.firstChild){this.scheduleHighlight();this.addDirtyNode(M||this.container.firstChild)}},reparseBuffer:function(){forEach(this.container.childNodes,function(M){M.dirty=true});if(this.container.firstChild){this.addDirtyNode(this.container.firstChild)}},addDirtyNode:function(N){N=N||this.container.firstChild;if(!N){return }for(var M=0;M<this.dirty.length;M++){if(this.dirty[M]==N){return }}if(N.nodeType!=3){N.dirty=true}this.dirty.push(N)},scheduleHighlight:function(){this.parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=this.parent.setTimeout(method(this,"highlightDirty"),this.options.passDelay)},getDirtyNode:function(){while(this.dirty.length>0){var M=this.dirty.pop();if((M.dirty||M.nodeType==3)&&M.parentNode){return M}}return null},highlightDirty:function(P){var O=P?Infinity:this.options.linesPerPass;var Q=select.markSelection(this.win);var N;while(O>0&&(N=this.getDirtyNode())){var M=this.highlight(N,O);if(M){O=M.left;if(M.node&&M.dirty){this.addDirtyNode(M.node)}}}select.selectMarked(Q);if(N){this.scheduleHighlight()}},documentScanner:function(N){var M=this,O=null;return function(){if(O&&O.parentNode!=M.container){O=null}var P=select.markSelection(M.win);var Q=M.highlight(O,N,true);select.selectMarked(P);O=Q?(Q.node&&Q.node.nextSibling):null;M.delayScanning()}},delayScanning:function(){if(this.scanner){this.parent.clearTimeout(this.documentScan);this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(R,P,N){var V=this.container,T=this;if(!V.firstChild){return }while(R&&(!R.parserFromHere||R.dirty)){R=R.previousSibling}if(R&&!R.nextSibling){return }function M(b,a){return !a.reduced&&a.currentText==b.value&&hasClass(a,b.style)}function Z(b,a){b.currentText=b.currentText.substring(a);b.reduced=true}function O(b){var a=T.doc.createElement("SPAN");a.className="part "+b.style;a.appendChild(T.doc.createTextNode(b.value));a.currentText=b.value;return a}var Y=G(R?R.nextSibling:V.firstChild),X=multiStringStream(Y),W=R?R.parserFromHere(X):H.Parser.make(X);var U={current:null,get:function(){if(!this.current){this.current=Y.nodes.shift()}return this.current},next:function(){this.current=null},remove:function(){V.removeChild(this.get());this.current=null},getNonEmpty:function(){var b=this.get();while(b&&b.nodeName=="SPAN"&&b.currentText==""){var a=b;if((!b.previousSibling||b.previousSibling.nodeName=="BR")&&(!b.nextSibling||b.nextSibling.nodeName=="BR")){this.next()}else{this.remove()}b=this.get();select.replaceSelection(a.firstChild,b.firstChild||b,0,0)}return b}};var S=false,Q=false;this.history.touch(R);forEach(W,function(c){var b=U.getNonEmpty();if(c.value=="\n"){if(b.nodeName!="BR"){throw"Parser out of sync. Expected BR."}if(b.dirty||!b.indentation){S=true}T.history.touch(b);b.parserFromHere=W.copy();b.indentation=c.indentation;b.dirty=false;if((P!==undefined&&--P<=0)||(!S&&Q&&!N)){throw StopIteration}S=false;Q=false;U.next()}else{if(b.nodeName!="SPAN"){throw"Parser out of sync. Expected SPAN."}if(b.dirty){S=true}Q=true;if(M(c,b)){b.dirty=false;U.next()}else{S=true;var a=O(c);V.insertBefore(a,b);var f=c.value.length;var e=0;while(f>0){b=U.get();var d=b.currentText.length;select.replaceSelection(b.firstChild,a.firstChild,f,e);if(d>f){Z(b,f);f=0}else{f-=d;e+=d;U.remove()}}}}});return{left:P,node:U.get(),dirty:S}}};return H})();addEventHandler(window,"load",function(){var A=window.frameElement.CodeMirror;A.editor=new Editor(A.options);if(A.options.initCallback){this.parent.setTimeout(function(){A.options.initCallback(A)},0)}});var select={};(function(){var D=document.selection&&document.selection.createRangeCollection;function F(J,K){while(J&&J.parentNode!=K){J=J.parentNode}return J}function I(J,K){while(!J.previousSibling&&J.parentNode!=K){J=J.parentNode}return F(J.previousSibling,K)}var C=false;if(D){select.markSelection=function(O){var L=O.document.selection;var J=L.createRange(),K=J.duplicate();var N=J.getBookmark();J.collapse(true);K.collapse(false);C=false;var M=O.document.body;return{start:{x:J.boundingLeft+M.scrollLeft-1,y:J.boundingTop+M.scrollTop},end:{x:K.boundingLeft+M.scrollLeft-1,y:K.boundingTop+M.scrollTop},window:O,bookmark:N}};select.selectMarked=function(L){if(!L||!C){return }C=false;var K=L.window.document.body.createTextRange(),N=K.duplicate();var J=false;if(L.start.y>=0&&L.end.y<L.window.document.body.clientHeight){try{K.moveToPoint(L.start.x,L.start.y);N.moveToPoint(L.end.x,L.end.y);K.setEndPoint("EndToStart",N);J=true}catch(M){}}if(!J){K.moveToBookmark(L.bookmark)}K.select()};select.replaceSelection=function(){C=true};select.selectionTopNode=function(Q,P){var O=Q.ownerDocument.selection;if(!O){return false}var N=O.createRange();N.collapse(P);var M=N.parentElement();if(M&&isAncestor(Q,M)){var L=N.duplicate();L.moveToElementText(M);if(N.compareEndPoints("StartToStart",L)==-1){return F(M,Q)}}N.pasteHTML("<span id='xxx-temp-xxx'></span>");var K=Q.ownerDocument.getElementById("xxx-temp-xxx");if(K){var J=I(K,Q);removeElement(K);return J}};select.focusAfterNode=function(J,L){var K=L.ownerDocument.body.createTextRange();K.moveToElementText(J||L);K.collapse(!J);K.select()};function A(M,L){var K=M.document.selection;if(K){var J=K.createRange();J.pasteHTML(L);J.collapse(false);J.select()}}select.insertNewlineAtCursor=function(J){A(J,"<br/>")};select.cursorPos=function(K,J){var P=K.ownerDocument.selection;if(!P){return null}var O=select.selectionTopNode(K,J);while(O&&O.nodeName!="BR"){O=O.previousSibling}var N=P.createRange(),L=N.duplicate();N.collapse(J);if(O){L.moveToElementText(O);L.collapse(false)}else{try{L.moveToElementText(K)}catch(M){return null}L.collapse(true)}N.setEndPoint("StartToStart",L);return{node:O,offset:N.text.length}};select.setCursorPos=function(M,K,N){function J(P){var O=M.ownerDocument.body.createTextRange();if(!P.node){O.moveToElementText(M);O.collapse(true)}else{O.moveToElementText(P.node);O.collapse(false)}O.move("character",P.offset);return O}var L=J(K);if(N&&N!=K){L.setEndPoint("EndToEnd",J(N))}L.select()};select.scrollToCursor=function(K){var J=K.ownerDocument.selection;if(!J){return null}J.createRange().scrollIntoView()}}else{var E=!window.scrollX&&!window.scrollY;select.markSelection=function(N){C=false;var M=N.getSelection();if(!M||M.rangeCount==0){return null}var L=M.getRangeAt(0);var J={start:{node:L.startContainer,offset:L.startOffset},end:{node:L.endContainer,offset:L.endOffset},window:N,scrollX:E&&N.document.body.scrollLeft,scrollY:E&&N.document.body.scrollTop};function K(O){while(O.node.nodeType!=3&&O.node.nodeName!="BR"){var P=O.node.childNodes[O.offset]||O.node.nextSibling;O.offset=0;while(!P&&O.node.parentNode){O.node=O.node.parentNode;P=O.node.nextSibling}O.node=P;if(!P){break}}}K(J.start);K(J.end);if(J.start.node){J.start.node.selectStart=J.start}if(J.end.node){J.end.node.selectEnd=J.end}return J};select.selectMarked=function(L){if(!L||!C){return }var M=L.window;var K=M.document.createRange();function J(N,O){if(N.node){delete N.node["select"+O];if(N.offset==0){K["set"+O+"Before"](N.node)}else{K["set"+O](N.node,N.offset)}}else{K.setStartAfter(M.document.body.lastChild||M.document.body)}}if(E){L.window.document.body.scrollLeft=L.scrollX;L.window.document.body.scrollTop=L.scrollY}J(L.end,"End");J(L.start,"Start");G(K,M)};select.replaceSelection=function(N,M,L,K){C=true;function J(O){var P=N["select"+O];if(P){if(P.offset>L){P.offset-=L}else{M["select"+O]=P;delete N["select"+O];P.node=M;P.offset+=(K||0)}}}J("Start");J("End")};function G(L,K){var J=K.getSelection();J.removeAllRanges();J.addRange(L)}function B(K){var J=K.getSelection();if(!J||J.rangeCount==0){return false}else{return J.getRangeAt(0)}}select.selectionTopNode=function(J,N){var M=B(J.ownerDocument.defaultView);if(!M){return false}var L=N?M.startContainer:M.endContainer;var K=N?M.startOffset:M.endOffset;if(L.nodeType==3){if(K>0){return F(L,J)}else{return I(L,J)}}else{if(L.nodeName=="HTML"){return(K==1?null:J.lastChild)}else{if(L==J){return(K==0)?null:L.childNodes[K-1]}else{if(K==L.childNodes.length){return F(L,J)}else{if(K==0){return I(L,J)}else{return F(L.childNodes[K-1],J)}}}}}};select.focusAfterNode=function(J,M){var L=M.ownerDocument.defaultView,K=L.document.createRange();K.setStartBefore(M.firstChild||M);if(J&&!J.firstChild){K.setEndAfter(J)}else{if(J){K.setEnd(J,J.childNodes.length)}else{K.setEndBefore(M.firstChild||M)}}K.collapse(false);G(K,L)};insertNodeAtCursor=function(M,L){var K=B(M);if(!K){return }if(M.opera&&K.startContainer.nodeType==3&&K.startOffset!=0){var J=K.startContainer,N=J.nodeValue;J.parentNode.insertBefore(M.document.createTextNode(N.substr(0,K.startOffset)),J);J.nodeValue=N.substr(K.startOffset);J.parentNode.insertBefore(L,J)}else{K.insertNode(L)}K.setEndAfter(L);K.collapse(false);G(K,M);return L};var H=/Gecko/.test(navigator.userAgent);select.insertNewlineAtCursor=function(J){insertNodeAtCursor(J,J.document.createElement("BR"));if(H){insertNodeAtCursor(J,J.document.createTextNode(""))}};select.cursorPos=function(J,M){var L=B(window);if(!L){return }var K=select.selectionTopNode(J,M);while(K&&K.nodeName!="BR"){K=K.previousSibling}L=L.cloneRange();L.collapse(M);if(K){L.setStartAfter(K)}else{L.setStartBefore(J)}return{node:K,offset:L.toString().length}};select.setCursorPos=function(J,O,N){var M=J.ownerDocument.defaultView,L=M.document.createRange();function K(T,U,R){if(!T){T=J.firstChild}else{T=T.nextSibling}if(!T){return }if(U==0){L["set"+R+"Before"](T);return true}var S=[];function P(W){if(W.nodeType==3){S.push(W)}else{forEach(W.childNodes,P)}}while(true){while(T&&!S.length){P(T);T=T.nextSibling}var V=S.shift();if(!V){return false}var Q=V.nodeValue.length;if(Q>=U){L["set"+R](V,U);return true}U-=Q}}N=N||O;if(K(N.node,N.offset,"End")&&K(O.node,O.offset,"Start")){G(L,M)}};select.scrollToCursor=function(L){var J=L.ownerDocument.body,M=L.ownerDocument.defaultView;var P=select.selectionTopNode(L,true)||L.firstChild;while(P&&!P.offsetTop){P=P.previousSibling}var O=0,N=P;while(N&&N.offsetParent){O+=N.offsetTop;N=N.offsetParent}var K=O-J.scrollTop;if(K<0||K>M.innerHeight-10){M.scrollTo(0,O)}}}}());(function(){var A={more:function(){return this.peek()!==null},applies:function(C){var B=this.peek();return(B!==null&&C(B))},nextWhile:function(B){while(this.applies(B)){this.next()}},equals:function(B){return B===this.peek()},endOfLine:function(){var B=this.peek();return B==null||B=="\n"}};window.singleStringStream=function(C){var D=0,B=0;return update({peek:function(){if(D<C.length){return C.charAt(D)}else{return null}},next:function(){if(D>=C.length){if(D<B){throw"End of stringstream reached without emptying buffer."}else{throw StopIteration}}return C.charAt(D++)},get:function(){var E=C.slice(B,D);B=D;return E}},A)};window.multiStringStream=function(C){C=iter(C);var B="",F=0;var E=null,D="";return update({peek:function(){if(!E){try{E=this.step()}catch(G){if(G!=StopIteration){throw G}else{E=null}}}return E},step:function(){if(E){var G=E;E=null;return G}while(F==B.length){D+=B;B="";F=0;B=C.next()}return B.charAt(F++)},next:function(){try{return this.step()}catch(G){if(G==StopIteration&&D.length>0){throw"End of stringstream reached without emptying buffer ('"+D+"')."}else{throw G}}},get:function(){var H=D;var G=E?F-1:F;D="";if(G>0){H+=B.slice(0,G);B=B.slice(G);F=E?1:0}return H}},A)}})();function History(B,C,A,E){this.container=B;this.maxDepth=C;this.commitDelay=A;this.editor=E;this.parent=E.parent;var D={text:"",from:null,to:null};this.first=D;this.last=D;this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[]}History.prototype={touch:function(A){this.setTouched(A);this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(method(this,"commit"),this.commitDelay)},undo:function(){this.commit();if(this.history.length){this.redoHistory.push(this.updateTo(this.history.pop(),"applyChain"))}},redo:function(){this.commit();if(this.redoHistory.length){this.addUndoLevel(this.updateTo(this.redoHistory.pop(),"applyChain"))}},push:function(F,E,D){var C=[];for(var B=0;B<D.length;B++){var A=(B==D.length-1)?E:this.container.ownerDocument.createElement("BR");C.push({from:F,to:A,text:D[B]});F=A}this.pushChains([C])},pushChains:function(A){this.commit();this.addUndoLevel(this.updateTo(A,"applyChain"));this.redoHistory=[]},reset:function(){this.commit();this.history=[];this.redoHistory=[]},textAfter:function(A){return this.after(A).text},nodeAfter:function(A){return this.after(A).to},nodeBefore:function(A){return this.before(A).from},commit:function(){this.parent.clearTimeout(this.commitTimeout);this.editor.highlightDirty(true);var B=this.touchedChains(),A=this;if(B.length){this.addUndoLevel(this.updateTo(B,"linkChain"));this.redoHistory=[]}},updateTo:function(C,B){var A=[],E=[];for(var D=0;D<C.length;D++){A.push(this.shadowChain(C[D]));E.push(this[B](C[D]))}if(B=="applyChain"){this.notifyDirty(E)}return A},notifyDirty:function(A){forEach(A,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},linkChain:function(C){for(var B=0;B<C.length;B++){var A=C[B];if(A.from){A.from.historyAfter=A}else{this.first=A}if(A.to){A.to.historyBefore=A}else{this.last=A}}},after:function(A){return A?A.historyAfter:this.first},before:function(A){return A?A.historyBefore:this.last},setTouched:function(A){if(A){if(!A.historyTouched){this.touched.push(A);A.historyTouched=true}}else{this.firstTouched=true}},addUndoLevel:function(A){this.history.push(A);if(this.history.length>this.maxDepth){this.history.shift()}},touchedChains:function(){var C=this;function H(J,I){return J.replace(/\u00a0/g," ")==I.replace(/\u00a0/g," ")}var D=null;function B(I){return I?I.historyTemp:D}function F(J,I){if(J){J.historyTemp=I}else{D=I}}var A=[];if(C.firstTouched){C.touched.push(null)}forEach(C.touched,function(K){if(K){K.historyTouched=false;if(K.parentNode!=C.container){return }}else{C.firstTouched=false}var M=[];for(var L=K?K.nextSibling:C.container.firstChild;L&&L.nodeName!="BR";L=L.nextSibling){if(L.currentText){M.push(L.currentText)}}var J={from:K,to:L,text:M.join("")};var I=C.after(K);if(!I||!H(I.text,J.text)||I.to!=J.to){A.push(J);F(K,J)}});function G(K,I){var J=I+"Sibling",L=K[J];while(L&&L.nodeName!="BR"){L=L[J]}return L}var E=[];C.touched=[];forEach(A,function(I){if(!B(I.from)){return }var L=[],K=I.from;while(true){var J=B(K);if(!J){break}L.unshift(J);F(K,null);if(!K){break}K=G(K,"previous")}K=I.to;while(true){var J=B(K);if(!J||!K){break}L.push(J);F(K,null);K=G(K,"next")}if(C.after(L[0].from)&&C.before(L[L.length-1].to)){E.push(L)}else{forEach(L,function(M){C.setTouched(M.from)})}});return E},recordChange:function(B,A){if(this.onChange){this.onChange(B,A)}},shadowChain:function(A){var E=[],D=this.after(A[0].from),C=A[A.length-1].to;while(true){E.push(D);var B=D.to;if(!B||B==C){break}else{D=B.historyAfter}}return E},applyChain:function(K){var J=select.cursorPos(this.container,false),L=this;function A(Q,P){var O=Q?Q.nextSibling:L.container.firstChild;while(O!=P){var N=O.nextSibling;removeElement(O);O=N}}var I=K[0].from,C=K[K.length-1].to;A(I,C);var E=C?function(N){L.container.insertBefore(N,C)}:function(N){L.container.appendChild(N)};for(var F=0;F<K.length;F++){var M=K[F];if(F>0){E(M.from)}var H=this.container.ownerDocument.createTextNode(M.text);E(H);if(J&&J.node==M.from){var G=0;var B=this.after(M.from);if(B&&F==K.length-1){for(var D=0;D<J.offset&&M.text.charAt(D)==B.text.charAt(D);D++){}if(J.offset>D){G=M.text.length-B.text.length}}select.setCursorPos(this.container,{node:M.from,offset:Math.max(0,J.offset+G)})}else{if(J&&(F==K.length-1)&&J.node&&J.node.parentNode!=this.container){select.setCursorPos(this.container,{node:M.from,offset:M.text.length})}}}this.linkChain(K);return I}};function method(B,A){return function(){B[A].apply(B,arguments)}}function update(B,C){for(var A in C){B[A]=C[A]}return B}var StopIteration={toString:function(){return"StopIteration"}};function iter(A){var B=0;if(A.next){return A}else{return{next:function(){if(B>=A.length){throw StopIteration}else{return A[++B]}}}}}function forEach(A,C){if(A.next){try{while(true){C(A.next())}}catch(D){if(D!=StopIteration){throw D}}}else{for(var B=0;B<A.length;B++){C(A[B])}}}function map(A,C){var B=[];forEach(A,function(D){B.push(C(D))});return B}function matcher(A){return function(B){return A.test(B)}}function hasClass(C,A){var B=C.className;return B&&new RegExp("(^| )"+A+"($| )").test(B)}function insertAfter(B,A){var D=A.parentNode;var C=A.nextSibling;if(C){D.insertBefore(B,C)}else{D.appendChild(B)}return B}function insertAtStart(A,B){if(B.firstChild){B.insertBefore(A,B.firstChild)}else{B.appendChild(A)}return A}function removeElement(A){if(A.parentNode){A.parentNode.removeChild(A)}}function clearElement(A){while(A.firstChild){A.removeChild(A.firstChild)}}function isAncestor(A,B){while(B=B.parentNode){if(A==B){return true}}return false}var nbsp=" ";function normalizeEvent(A){if(!A.stopPropagation){A.stopPropagation=function(){this.cancelBubble=true};A.preventDefault=function(){this.returnValue=false}}if(!A.stop){A.stop=function(){this.stopPropagation();this.preventDefault()}}if(A.type=="keypress"){if(A.charCode===0||A.charCode==undefined){A.code=A.keyCode}else{A.code=A.charCode}A.character=String.fromCharCode(A.code)}return A}function addEventHandler(C,B,A){function D(E){A(normalizeEvent(E||window.event))}if(typeof C.addEventListener=="function"){C.addEventListener(B,D,false);return function(){C.removeEventListener(B,D,false)}}else{C.attachEvent("on"+B,D);return function(){C.detachEvent("on"+B,D)}}}function removeEventHandler(A){A()};
